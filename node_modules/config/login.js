var
  crypto        = require('crypto'),
  rand          = require('csprng'),
  mongoose      = require('mongoose'),
  gravatar      = require('gravatar'),
  user          = require('config/models');

exports.login = function(username,password,callback) {

  user.find({username: username}, function(err ,users){

    if(users.length !== 0){

      var
        temp                = users[0].salt,
        hash_db             = users[0].hashed_password,
        id                  = users[0].token,
        newpass             = temp + password,
        hashed_password     = crypto.createHash('sha512').update(newpass).digest("hex"),
        grav_url            = gravatar.url(username, {s: '200', r: 'pg', d: '404'});

      if(hash_db == hashed_password){
        callback({status: 'success', msg: "Sucessfully login", user: {
          token: id
        }});
      } else {
        callback({status: 'error', errors: [{
            param: "username",
            msg: "Invalid password.",
            value: username
          }
        ]});
      }
    } else {
      callback({status: 'error', errors: [{
          param: "username",
          msg: "User does not exist.",
          value: username
        }
      ]});
    }
  });
}
