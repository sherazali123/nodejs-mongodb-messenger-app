var
  crypto      = require('crypto'),
  rand        = require('csprng'),
  mongoose    = require('mongoose'),
  user        = require('config/models');

exports.register = function(username, password, gender, callback){
  var
    // a random string used add salt in the password
    temp              = rand(160, 36),
    // generate new password
    newpass           = temp + password,
    // create token from the username and rand (csprng) mdoule
    token             = crypto.createHash('sha512').update(username +rand).digest("hex"),
    hashed_password   = crypto.createHash('sha512').update(newpass).digest("hex"),
    // create user instance from userSchema to register new user
    newuser           = new user({
     token: token,
     username: username,
     hashed_password: hashed_password,
     salt :temp
    });
  // find if username already exists
  user.find({username: username},function(err,users){
    var
      // number of users found with the given username
      len = users.length;
    // register only if no user found in the users collection
    if(len === 0){
      newuser.save(function (err) {
        callback({status: 'success', msg: "Sucessfully Registered", user: {
          token: newuser.token,
        }});
      });
    } else {
      callback({status: 'error', errors: [{
          param: "username",
          msg: "Username already registered.",
          value: username
        }
      ]});
    }
  });

};
